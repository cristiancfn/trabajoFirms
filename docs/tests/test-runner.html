<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas Unitarias - Proyecto GeoFires</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .test-passed {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .test-failed {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .test-running {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .test-summary {
            background-color: #e2e3e5;
            border: 1px solid #d6d8db;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .test-category {
            margin-bottom: 30px;
        }
        
        .test-category h3 {
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Panel de Control -->
            <div class="col-md-3 bg-light p-4">
                <h2 class="mb-4">üß™ Test Runner</h2>
                
                <div class="d-grid gap-2 mb-4">
                    <button id="runAllTests" class="btn btn-primary btn-lg">
                        üöÄ Ejecutar Todas las Pruebas
                    </button>
                    <button id="runUtilsTests" class="btn btn-outline-primary">
                        üìä Pruebas de Utilidades
                    </button>
                    <button id="runConstantsTests" class="btn btn-outline-primary">
                        ‚öôÔ∏è Pruebas de Constantes
                    </button>
                    <button id="runMapTests" class="btn btn-outline-primary">
                        üó∫Ô∏è Pruebas de Mapa
                    </button>
                    <button id="runServiceTests" class="btn btn-outline-primary">
                        üîå Pruebas de Servicios
                    </button>
                    <button id="runMarkerTests" class="btn btn-outline-primary">
                        üìç Pruebas de Marcadores
                    </button>
                    <button id="runIntegrationTests" class="btn btn-outline-primary">
                        üîó Pruebas de Integraci√≥n
                    </button>
                </div>
                
                <div class="test-summary">
                    <h5>üìä Resumen</h5>
                    <div id="testSummary">
                        <p>Total: <span id="totalTests">0</span></p>
                        <p>Pasadas: <span id="passedTests" class="text-success">0</span></p>
                        <p>Fallidas: <span id="failedTests" class="text-danger">0</span></p>
                        <p>Porcentaje: <span id="successRate">0%</span></p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button id="clearResults" class="btn btn-outline-secondary btn-sm">
                        üóëÔ∏è Limpiar Resultados
                    </button>
                    <button id="exportResults" class="btn btn-outline-info btn-sm">
                        üì§ Exportar Resultados
                    </button>
                </div>
            </div>
            
            <!-- Panel de Resultados -->
            <div class="col-md-9 p-4">
                <h1 class="mb-4">Proyecto GeoFires - Pruebas Unitarias</h1>
                
                <!-- Descripci√≥n del Proyecto -->
                <div class="alert alert-info">
                    <h5>üìã Descripci√≥n del Proyecto</h5>
                    <p>
                        <strong>GeoFires</strong> es una aplicaci√≥n de mapeo de incendios forestales que utiliza 
                        datos de la NASA FIRMS (Fire Information for Resource Management System) para mostrar 
                        incendios activos en Colombia en tiempo real.
                    </p>
                    <p>
                        <strong>Funcionalidades principales:</strong> Mapeo interactivo con Leaflet, filtrado 
                        geogr√°fico por Colombia, marcadores de incendios con informaci√≥n detallada, y 
                        visualizaci√≥n de datos de confianza y brillo t√©rmico.
                    </p>
                </div>
                
                <!-- Estado de las Pruebas -->
                <div id="testStatus" class="alert alert-warning">
                    <strong>Estado:</strong> Las pruebas no han sido ejecutadas a√∫n.
                </div>
                
                <!-- Resultados de las Pruebas -->
                <div id="testResults">
                    <!-- Los resultados se mostrar√°n aqu√≠ din√°micamente -->
                </div>
                
                <!-- Consola de Salida -->
                <div class="mt-4">
                    <h5>üìù Consola de Salida</h5>
                    <div id="consoleOutput" class="console-output">
                        Sistema de pruebas listo. Ejecuta las pruebas para ver los resultados.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Scripts de Pruebas -->
    <script type="module">
        // Importar las funciones del proyecto para probarlas
        import { isInColombia, colorByConfidence, formatAcqTime } from '../js/utils/helpers.js';
        import { colombiaBounds, mapConfig, tileLayerConfig } from '../js/utils/constants.js';
        import { config } from '../js/config.js';
        
        // Hacer las funciones disponibles globalmente para las pruebas
        window.isInColombia = isInColombia;
        window.colorByConfidence = colorByConfidence;
        window.formatAcqTime = formatAcqTime;
        window.colombiaBounds = colombiaBounds;
        window.mapConfig = mapConfig;
        window.tileLayerConfig = tileLayerConfig;
        window.config = config;
        
        // Importar las funciones de prueba simplificadas
        import { 
            runAllTests, 
            runUtilsTests, 
            runConstantsTests, 
            runMapTests, 
            runServiceTests, 
            runMarkerTests, 
            runIntegrationTests 
        } from './simple-tests.js';
        
        // Mock de Leaflet para las pruebas
        window.L = {
            map: (id, options) => ({
                setView: (center, zoom) => ({ center, zoom }),
                addTo: (map) => map
            }),
            tileLayer: (url, options) => ({ url, options }),
            latLngBounds: (bounds) => ({
                extend: (layerBounds) => layerBounds,
                isValid: () => true
            }),
            circleMarker: (latlng, options) => ({
                bindPopup: (content) => ({ content }),
                addTo: (map) => map
            }),
            geoJSON: (data, options) => ({
                addTo: (map) => map,
                getBounds: () => ({ isValid: () => true })
            })
        };
        
        // Mock de funciones globales
        window.global = window;
        window.jest = { fn: () => {} };
        
        // Funci√≥n para crear marcadores de incendios (mock)
        window.createFireMarker = (feature, latlng) => {
            const properties = feature.properties || {};
            return {
                bindPopup: (content) => ({ content }),
                addTo: (map) => map
            };
        };
        
        window.addFireMarkersToMap = (geojson, map) => {
            return {
                addTo: (map) => map,
                getBounds: () => ({ isValid: () => true })
            };
        };
        
        // Funci√≥n createPopupContent para las pruebas
        window.createPopupContent = (properties) => {
            const {
                acq_date = '',
                acq_time = '',
                brightness = '',
                confidence = '',
                frp = '',
                latitude = '',
                longitude = ''
            } = properties;

            const time = acq_time ? formatAcqTime(acq_time) : '';
            const lat = typeof latitude === 'number' ? latitude.toFixed(5) : '';
            const lon = typeof longitude === 'number' ? longitude.toFixed(5) : '';

            return `
                <strong>FIRMS MODIS (24h)</strong><br/>
                <b>Fecha:</b> ${acq_date} ${time}<br/>
                <b>Brightness:</b> ${brightness}<br/>
                <b>Confidence:</b> ${confidence}<br/>
                <b>FRP:</b> ${frp}<br/>
                <b>Lat/Lon:</b> ${lat}, ${lon}
            `;
        };
        
        // Interceptar console.log para mostrar en la interfaz
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleGroup = console.group;
        const originalConsoleGroupEnd = console.groupEnd;
        
        const consoleOutput = document.getElementById('consoleOutput');
        
        function appendToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'group' ? 'üìã' : '‚ÑπÔ∏è';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            appendToConsole(args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            appendToConsole(args.join(' '), 'error');
        };
        
        console.group = function(...args) {
            originalConsoleGroup.apply(console, args);
            appendToConsole(args.join(' '), 'group');
        };
        
        console.groupEnd = function() {
            originalConsoleGroupEnd.apply(console);
        };
        
        // Configurar event listeners
        document.getElementById('runAllTests').addEventListener('click', async () => {
            clearResults();
            updateTestStatus('Ejecutando todas las pruebas...', 'info');
            try {
                const results = await runAllTests();
                updateTestSummary(results.total, results.passed, results.failed);
                updateTestStatus(`Pruebas completadas. ${results.passed}/${results.total} pasaron.`, 'success');
            } catch (error) {
                console.error('Error ejecutando pruebas:', error);
                updateTestStatus('Error ejecutando las pruebas. Revisa la consola.', 'danger');
            }
        });
        
        document.getElementById('runUtilsTests').addEventListener('click', async () => {
            clearResults();
            updateTestStatus('Ejecutando pruebas de utilidades...', 'info');
            try {
                const results = await runUtilsTests();
                updateTestSummary(results.total, results.passed, results.failed);
                updateTestStatus(`Pruebas de utilidades completadas. ${results.passed}/${results.total} pasaron.`, 'success');
            } catch (error) {
                console.error('Error ejecutando pruebas de utilidades:', error);
                updateTestStatus('Error ejecutando las pruebas. Revisa la consola.', 'danger');
            }
        });
        
        document.getElementById('runConstantsTests').addEventListener('click', async () => {
            clearResults();
            updateTestStatus('Ejecutando pruebas de constantes...', 'info');
            try {
                const results = await runConstantsTests();
                updateTestSummary(results.total, results.passed, results.failed);
                updateTestStatus(`Pruebas de constantes completadas. ${results.passed}/${results.total} pasaron.`, 'success');
            } catch (error) {
                console.error('Error ejecutando pruebas de constantes:', error);
                updateTestStatus('Error ejecutando las pruebas. Revisa la consola.', 'danger');
            }
        });
        
        document.getElementById('runMapTests').addEventListener('click', async () => {
            clearResults();
            updateTestStatus('Ejecutando pruebas de mapa...', 'info');
            try {
                const results = await runMapTests();
                updateTestSummary(results.total, results.passed, results.failed);
                updateTestStatus(`Pruebas de mapa completadas. ${results.passed}/${results.total} pasaron.`, 'success');
            } catch (error) {
                console.error('Error ejecutando pruebas de mapa:', error);
                updateTestStatus('Error ejecutando las pruebas. Revisa la consola.', 'danger');
            }
        });
        
        document.getElementById('runServiceTests').addEventListener('click', async () => {
            clearResults();
            updateTestStatus('Ejecutando pruebas de servicios...', 'info');
            try {
                const results = await runServiceTests();
                updateTestSummary(results.total, results.passed, results.failed);
                updateTestStatus(`Pruebas de servicios completadas. ${results.passed}/${results.total} pasaron.`, 'success');
            } catch (error) {
                console.error('Error ejecutando pruebas de servicios:', error);
                updateTestStatus('Error ejecutando las pruebas. Revisa la consola.', 'danger');
            }
        });
        
        document.getElementById('runMarkerTests').addEventListener('click', async () => {
            clearResults();
            updateTestStatus('Ejecutando pruebas de marcadores...', 'info');
            try {
                const results = await runMarkerTests();
                updateTestSummary(results.total, results.passed, results.failed);
                updateTestStatus(`Pruebas de marcadores completadas. ${results.passed}/${results.total} pasaron.`, 'success');
            } catch (error) {
                console.error('Error ejecutando pruebas de marcadores:', error);
                updateTestStatus('Error ejecutando las pruebas. Revisa la consola.', 'danger');
            }
        });
        
        document.getElementById('runIntegrationTests').addEventListener('click', async () => {
            clearResults();
            updateTestStatus('Ejecutando pruebas de integraci√≥n...', 'info');
            try {
                const results = await runIntegrationTests();
                updateTestSummary(results.total, results.passed, results.failed);
                updateTestStatus(`Pruebas de integraci√≥n completadas. ${results.passed}/${results.total} pasaron.`, 'success');
            } catch (error) {
                console.error('Error ejecutando pruebas de integraci√≥n:', error);
                updateTestStatus('Error ejecutando las pruebas. Revisa la consola.', 'danger');
            }
        });
        
        document.getElementById('clearResults').addEventListener('click', clearResults);
        document.getElementById('exportResults').addEventListener('click', exportResults);
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('consoleOutput').textContent = 'Sistema de pruebas listo. Ejecuta las pruebas para ver los resultados.';
            updateTestStatus('Resultados limpiados.', 'secondary');
            updateTestSummary(0, 0, 0);
        }
        
        function updateTestStatus(message, type) {
            const statusElement = document.getElementById('testStatus');
            statusElement.className = `alert alert-${type}`;
            statusElement.innerHTML = `<strong>Estado:</strong> ${message}`;
        }
        
        function updateTestSummary(total, passed, failed) {
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            const rate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            document.getElementById('successRate').textContent = `${rate}%`;
        }
        
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: parseInt(document.getElementById('totalTests').textContent),
                    passed: parseInt(document.getElementById('passedTests').textContent),
                    failed: parseInt(document.getElementById('failedTests').textContent),
                    successRate: document.getElementById('successRate').textContent
                },
                consoleOutput: document.getElementById('consoleOutput').textContent
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-results-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Sistema de pruebas unitarias cargado correctamente');
            console.log('üìã Proyecto: GeoFires - Mapeo de Incendios Forestales');
            console.log('üîß Funciones disponibles: runAllTests(), runTestsByCategory()');
            updateTestStatus('Sistema de pruebas listo. Selecciona una opci√≥n para comenzar.', 'success');
        });
    </script>
</body>
</html>
